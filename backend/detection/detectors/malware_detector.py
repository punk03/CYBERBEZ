"""Malware detection detector."""

from typing import Dict, Any, Optional
import re

from backend.detection.detectors.base import BaseDetector
from backend.common.logging import get_logger

logger = get_logger(__name__)


class MalwareDetector(BaseDetector):
    """Detector for malware activity."""
    
    # Malware indicators
    MALWARE_PATTERNS = [
        # File operations
        r"(?i)(\.exe|\.bat|\.cmd|\.scr|\.vbs|\.js|\.ps1)",
        r"(?i)(powershell|cmd\.exe|wscript|cscript)",
        
        # Network activity
        r"(?i)(c2|command.?and.?control|beacon)",
        r"(?i)(download|upload).*malware",
        
        # Suspicious strings
        r"(?i)(trojan|virus|worm|ransomware|spyware)",
        r"(?i)(keylogger|backdoor|rootkit)",
        
        # Process injection
        r"(?i)(process.?injection|dll.?injection)",
        r"(?i)(createprocess|createremotethread)",
    ]
    
    def __init__(self, config: Optional[Dict[str, Any]] = None):
        """Initialize malware detector."""
        super().__init__("malware", config)
        self.patterns = [re.compile(pattern) for pattern in self.MALWARE_PATTERNS]
        self.min_matches = config.get("min_matches", 2) if config else 2
    
    async def detect(self, log_entry: Dict[str, Any]) -> Optional[Dict[str, Any]]:
        """Detect malware activity."""
        if not self.enabled:
            return None
        
        try:
            message = str(log_entry.get("message", "")).lower()
            matches = []
            
            # Check patterns
            for pattern in self.patterns:
                if pattern.search(message):
                    matches.append(pattern.pattern)
            
            if len(matches) >= self.min_matches:
                logger.warning(
                    f"Malware activity detected: {len(matches)} indicators matched"
                )
                
                return {
                    "attack_type": "malware",
                    "detector": self.name,
                    "indicators": matches,
                    "match_count": len(matches),
                    "severity": "high",
                    "confidence": min(1.0, len(matches) / (self.min_matches * 2)),
                }
            
            # Check ML prediction
            ml_prediction = log_entry.get("ml_prediction", {})
            if ml_prediction.get("attack_type") == "malware":
                confidence = ml_prediction.get("confidence", 0.0)
                if confidence > 0.7:
                    return {
                        "attack_type": "malware",
                        "detector": self.name,
                        "ml_detected": True,
                        "confidence": confidence,
                        "severity": "high",
                    }
            
            return None
        
        except Exception as e:
            logger.error(f"Error in malware detection: {e}", exc_info=True)
            return None
